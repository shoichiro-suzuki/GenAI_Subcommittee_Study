# 基本設計書

## 1. システム構成

### 1.1 レイヤー構造
```
┌─────────────────────────────┐
│   GUI Layer (main.py)       │  ← ユーザーインターフェース
├─────────────────────────────┤
│   Service Layer             │  ← ビジネスロジック
│   (todo_service.py)         │
├─────────────────────────────┤
│   Data Layer                │  ← データ永続化
│   (data_manager.py)         │
├─────────────────────────────┤
│   Model Layer               │  ← データモデル
│   (models.py)               │
└─────────────────────────────┘
         ↓
    todos.json
```

### 1.2 責務分離

| レイヤー | モジュール | 責務 |
|---------|----------|------|
| GUI | `main.py` | tkinterウィジェット管理、イベント処理、表示更新 |
| Service | `todo_service.py` | Todo操作ロジック、バリデーション |
| Data | `data_manager.py` | JSON読み書き、データ整合性管理 |
| Model | `models.py` | データクラス定義、型定義 |

## 2. モジュール設計

### 2.1 models.py
**データクラス定義**

主要クラス:
- `Todo`: id, title, completed, created_at, updated_at
- `TodoDatabase`: version, todos, next_id

### 2.2 data_manager.py
**JSON操作**

主要関数:
- `load_data()`: JSONファイル読み込み
- `save_data()`: JSONファイル書き込み
- `backup_data()`: バックアップ作成
- `init_data()`: 初期データ生成

主要機能:
- ファイル存在確認
- JSON parse/stringify
- エラーハンドリング（破損検知、バックアップ）

### 2.3 todo_service.py
**Todoビジネスロジック**

主要関数:
- `add_todo(title)`: Todo追加
- `list_todos()`: 全Todo取得
- `toggle_todo(id)`: 完了状態切り替え
- `delete_todo(id)`: Todo削除

主要機能:
- バリデーション（タイトル長、ID存在確認）
- ID自動採番
- 日時自動設定
- データ操作後の自動保存

### 2.4 main.py
**GUIインターフェース**

主要関数:
- `build_ui()`: UIコンポーネント構築
- `refresh_list()`: Todo一覧更新
- `add_todo_handler()`: Todo追加イベント
- `toggle_todo_handler()`: 完了切替イベント
- `delete_todo_handler()`: 削除イベント
- `main()`: エントリーポイント

主要機能:
- tkinterウィジェット構築
- イベントハンドラ登録
- データ表示更新
- エラーダイアログ表示

## 3. データフロー

### 3.1 Todo追加の流れ
```
ユーザー操作（[追加]ボタンまたはEnter）
  ↓
main.py (add_todo_handler)
  ↓
todo_service.py (add_todo)
  ↓ バリデーション
  ↓ ID採番、日時設定
  ↓
data_manager.py (save_data)
  ↓
todos.json
  ↓
main.py (refresh_list) ← 一覧更新
```

### 3.2 起動時の初期化
```
main.py (main)
  ↓ Tkウィンドウ作成
  ↓ UIコンポーネント構築
  ↓
data_manager.py (load_data)
  ↓
todos.json 存在確認
  ├─ あり → 読み込み
  └─ なし → init_data() → 初期JSON生成
  ↓
main.py (refresh_list) ← 初期データ表示
  ↓
mainloop() ← イベントループ開始
```

## 4. エラーハンドリング戦略

### 4.1 エラー分類
| エラー種別 | 処理方針 |
|----------|---------|
| ファイル不存在 | 自動生成（初回起動） |
| JSON破損 | バックアップ作成 → 初期化 |
| 不正なID指定 | エラーメッセージ表示 |
| バリデーション失敗 | エラーメッセージ表示 |

### 4.2 エラー表示戦略
- **メッセージボックス**: エラー、警告、確認ダイアログ
- **ログファイル**: なし（シンプル化のため）

## 5. 依存関係

### 5.1 外部ライブラリ
標準ライブラリのみ使用（外部依存なし）:
- tkinter: GUI構築
- json: JSON操作
- datetime: 日時処理
- dataclasses: データクラス
- pathlib: パス操作
- typing: 型ヒント

### 5.2 モジュール間依存
```
main.py
  ↓ import
todo_service.py
  ↓ import
data_manager.py
  ↓ import
models.py
```

**依存方向**: 上位レイヤーが下位レイヤーに依存（一方向）

## 6. 拡張性考慮

### 6.1 機能追加の容易性
- **新規UI操作追加**: main.pyにウィジェットとハンドラ追加
- **新規フィールド追加**: models.pyとdata_manager、表示ロジックを更新
- **新規ビジネスロジック**: todo_service.pyにメソッド追加

### 6.2 バージョン管理
- `version`フィールドでスキーマバージョン管理
- 将来的なマイグレーション対応可能
