# システムロジック解説書

## 1. データ永続化ロジック

### 1.1 自動保存メカニズム
```python
# すべてのCUD操作後に自動保存
add_todo(title) → save_data()
toggle_todo(id) → save_data()
delete_todo(id) → save_data()
```

**設計意図**:
- データ損失リスク最小化
- ユーザーによる明示的な保存操作不要
- トランザクション単位での永続化

### 1.2 初回起動時の初期化
```python
load_data():
    if not todos.json.exists():
        return init_data()  # 空DBを生成・保存
```

**処理内容**:
1. JSONファイル存在確認
2. 不存在時 → 初期構造生成
   - version: "1.0"
   - todos: []
   - next_id: 1
3. ファイル書き込み

### 1.3 JSON破損時のリカバリ
```python
load_data():
    try:
        data = json.loads(file.read())
    except JSONDecodeError:
        backup_data()  # .backup拡張子で保存
        return init_data()  # 新規DB生成
```

**リカバリフロー**:
1. JSON parseエラー検知
2. 破損ファイルをバックアップ
3. 初期状態で再起動
4. ユーザーに警告表示

## 2. ID管理ロジック

### 2.1 ID自動採番
```python
add_todo(title):
    new_todo = Todo(
        id=db.next_id,  # 現在の採番値
        ...
    )
    db.next_id += 1  # 次回用にインクリメント
```

**特徴**:
- 単調増加（削除してもIDは再利用しない）
- 採番カウンターは`TodoDatabase.next_id`で永続化
- 一意性保証

### 2.2 ID検索とバリデーション
```python
toggle_todo(todo_id):
    todo = next((t for t in db.todos if t.id == todo_id), None)
    if todo is None:
        raise ValueError(f"ID {todo_id} not found")
```

**バリデーション**:
- 存在しないID → エラー
- 型不一致 → argparseで事前検証

## 3. 日時管理ロジック

### 3.1 タイムスタンプ自動設定
```python
add_todo(title):
    now = datetime.now().isoformat()
    todo = Todo(
        created_at=now,
        updated_at=now,
        ...
    )

toggle_todo(id):
    todo.updated_at = datetime.now().isoformat()
```

**フォーマット**:
- ISO 8601形式: `2025-01-15T10:30:45.123456`
- タイムゾーン: ローカル時刻

### 3.2 日時表示の整形
```python
display_todos(todos):
    dt = datetime.fromisoformat(todo.created_at)
    print(dt.strftime("%Y-%m-%d %H:%M"))
```

**表示形式**: `yyyy-MM-dd HH:mm`（秒以下は省略）

## 4. バリデーションロジック

### 4.1 タイトル検証
```python
add_todo(title):
    if not title or len(title) > 200:
        raise ValueError("タイトルは1-200文字")
```

**検証項目**:
- 空文字NG
- 200文字超過NG
- 前後の空白はトリムしない（仕様）

### 4.2 ID検証
```python
# argparseレベルで型検証
parser.add_argument("id", type=int)

# サービスレベルで存在確認
if not find_todo_by_id(id):
    raise ValueError(f"ID {id} not found")
```

**2段階検証**:
1. CLI層: 型チェック（intか？）
2. Service層: 存在チェック

## 5. エラーハンドリングロジック

### 5.1 エラー伝播戦略
```
Service層でValueErrorスロー
    ↓
CLI層でキャッチ
    ↓
ユーザーにメッセージ表示
    ↓
終了コード1で終了
```

### 5.2 主要エラーパターン
| エラー | 発生場所 | 処理 |
|-------|---------|------|
| JSONDecodeError | data_manager.py | バックアップ→初期化 |
| ValueError | todo_service.py | エラーメッセージ→終了 |
| IOError | data_manager.py | 標準エラー出力→終了 |

### 5.3 ユーザーフレンドリーなメッセージ
```python
# 技術的詳細は隠蔽
❌ "JSONDecodeError at line 5"
✅ "データファイルの読み込みに失敗しました"

# 具体的なアクション提示
❌ "Invalid ID"
✅ "指定されたIDのTodoが見つかりません: 123"
```

## 6. 状態管理ロジック

### 6.1 完了状態のトグル
```python
toggle_todo(id):
    todo.completed = not todo.completed
    todo.updated_at = now()
```

**特徴**:
- 真偽値反転のみ（3状態以上は持たない）
- 完了→未完了への戻しも可能

### 6.2 状態表示
```python
display_todos(todos):
    status = "完了" if todo.completed else "未完了"
```

**表示仕様**:
- True → "完了"
- False → "未完了"

## 7. データ一貫性保証

### 7.1 原子性の確保
```python
# 操作完了後に一括保存
add_todo(title):
    # 1. Todoオブジェクト作成
    # 2. リストに追加
    # 3. next_id更新
    # 4. save_data()  ← この時点で初めて永続化
```

**ACID特性**:
- Atomicity: 全操作完了後に保存
- Consistency: バリデーション→操作→保存の順
- Isolation: 単一ユーザー前提で不要
- Durability: ファイル書き込みで保証

### 7.2 データ整合性チェック
```python
# next_idは常に最大ID+1以上
assert db.next_id > max(t.id for t in db.todos)

# 重複ID検知
ids = [t.id for t in db.todos]
assert len(ids) == len(set(ids))
```

**チェックタイミング**: load_data()時（デバッグビルドのみ）

## 8. パフォーマンス最適化

### 8.1 全件読み込み戦略
```python
# 毎回全件読み込み
list_todos():
    return load_data().todos  # O(n)
```

**設計判断**:
- 想定データ量: 数百件以下
- メモリ使用量: 無視できるレベル
- シンプルさ優先

### 8.2 線形検索
```python
# ID検索は線形探索
find_todo = next((t for t in todos if t.id == id), None)
```

**理由**:
- データ量が少ないため、インデックス不要
- コード複雑性の回避

## 9. 拡張性考慮ロジック

### 9.1 バージョン管理
```python
TodoDatabase:
    version: str = "1.0"
```

**将来のマイグレーション**:
```python
if db.version == "1.0":
    migrate_to_v2(db)
```

### 9.2 フィールド追加の容易性
```python
# dataclassの利点
@dataclass
class Todo:
    # 新フィールド追加時
    priority: int = 0  # デフォルト値で後方互換
```

**後方互換性**:
- 古いJSONにはpriority未含有
- デシリアライズ時にデフォルト値適用
