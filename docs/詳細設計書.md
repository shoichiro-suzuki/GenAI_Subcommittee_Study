# 詳細設計書

## 1. models.py

### 1.1 Todo クラス
```python
@dataclass
class Todo:
    id: int
    title: str
    completed: bool
    created_at: str  # ISO 8601形式
    updated_at: str  # ISO 8601形式
```

**フィールド仕様**:
| フィールド | 型 | 必須 | デフォルト | 説明 |
|-----------|----|----|---------|------|
| id | int | Yes | - | 一意識別子（1から連番） |
| title | str | Yes | - | タスクタイトル（1-200文字） |
| completed | bool | Yes | False | 完了状態 |
| created_at | str | Yes | - | 作成日時（ISO 8601） |
| updated_at | str | Yes | - | 更新日時（ISO 8601） |

### 1.2 TodoDatabase クラス
```python
@dataclass
class TodoDatabase:
    version: str
    todos: List[Todo]
    next_id: int
```

**フィールド仕様**:
| フィールド | 型 | 説明 |
|-----------|----|----|
| version | str | スキーマバージョン（"1.0"） |
| todos | List[Todo] | Todoリスト |
| next_id | int | 次に採番するID |

## 2. data_manager.py

### 2.1 load_data()
```python
def load_data() -> TodoDatabase
```

**処理フロー**:
1. JSONファイル存在確認
2. 存在しない場合 → `init_data()`呼び出し
3. JSON読み込み
4. parse失敗時 → `backup_data()` → `init_data()`
5. TodoDatabaseオブジェクトに変換
6. 返却

**エラー処理**:
- JSONDecodeError → バックアップ作成後、初期化
- FileNotFoundError → 初期データ生成

### 2.2 save_data()
```python
def save_data(db: TodoDatabase) -> None
```

**処理フロー**:
1. TodoDatabaseを辞書に変換
2. JSON文字列化（indent=2）
3. ファイル書き込み

**エラー処理**:
- IOError → 標準エラー出力にメッセージ

### 2.3 backup_data()
```python
def backup_data() -> None
```

**処理フロー**:
1. 現在のtodos.jsonをtodos.json.backupにコピー
2. タイムスタンプ付きバックアップ作成（オプション）

### 2.4 init_data()
```python
def init_data() -> TodoDatabase
```

**処理フロー**:
1. 空のTodoDatabase作成
2. version="1.0", todos=[], next_id=1
3. `save_data()`呼び出し
4. 返却

## 3. todo_service.py

### 3.1 add_todo()
```python
def add_todo(title: str) -> Todo
```

**処理フロー**:
1. タイトルバリデーション（1-200文字）
2. 現在日時取得
3. Todoオブジェクト作成
   - id = db.next_id
   - title = 引数のtitle
   - completed = False
   - created_at = 現在日時
   - updated_at = 現在日時
4. db.todosに追加
5. db.next_id += 1
6. `save_data()`呼び出し
7. 作成したTodo返却

**バリデーション**:
- タイトル長: 1-200文字
- エラー時: ValueErrorスロー

### 3.2 list_todos()
```python
def list_todos() -> List[Todo]
```

**処理フロー**:
1. `load_data()`呼び出し
2. db.todosを返却

**ソート順**: ID昇順（挿入順）

### 3.3 toggle_todo()
```python
def toggle_todo(todo_id: int) -> Todo
```

**処理フロー**:
1. `load_data()`呼び出し
2. 指定IDのTodo検索
3. 見つからない場合 → ValueErrorスロー
4. completedフラグ反転
5. updated_at更新
6. `save_data()`呼び出し
7. 更新したTodo返却

**バリデーション**:
- ID存在確認
- エラー時: ValueErrorスロー

### 3.4 delete_todo()
```python
def delete_todo(todo_id: int) -> None
```

**処理フロー**:
1. `load_data()`呼び出し
2. 指定IDのTodo検索
3. 見つからない場合 → ValueErrorスロー
4. db.todosから削除
5. `save_data()`呼び出し

**バリデーション**:
- ID存在確認
- エラー時: ValueErrorスロー

## 4. main.py

### 4.1 build_ui()
```python
def build_ui(root: Tk) -> None
```

**処理内容**:
1. 入力エリア構築（Entry + Button）
2. 一覧エリア構築（Treeview + Scrollbar）
3. 操作ボタンエリア構築（Button × 2）
4. イベントハンドラ登録

### 4.2 refresh_list()
```python
def refresh_list() -> None
```

**処理フロー**:
1. Treeview既存項目削除
2. `list_todos()`呼び出し
3. 各TodoをTreeviewに挿入
4. 完了済みは背景色変更

### 4.3 add_todo_handler()
```python
def add_todo_handler() -> None
```

**処理フロー**:
1. Entry値取得
2. 空チェック → 警告ダイアログ
3. `add_todo()`呼び出し
4. エラー時 → エラーダイアログ
5. `refresh_list()`呼び出し
6. Entryクリア

### 4.4 toggle_todo_handler()
```python
def toggle_todo_handler() -> None
```

**処理フロー**:
1. 選択行取得
2. 未選択時 → 何もしない
3. IDを取得
4. `toggle_todo()`呼び出し
5. `refresh_list()`呼び出し

### 4.5 delete_todo_handler()
```python
def delete_todo_handler() -> None
```

**処理フロー**:
1. 選択行取得
2. 未選択時 → 何もしない
3. 確認ダイアログ表示
4. キャンセル時 → 中断
5. `delete_todo()`呼び出し
6. `refresh_list()`呼び出し

### 4.6 main()
```python
def main() -> None
```

**処理フロー**:
1. Tkウィンドウ作成
2. `build_ui()`呼び出し
3. `refresh_list()`呼び出し（初期データ読み込み）
4. `mainloop()`開始

## 5. ビルド設定

### 5.1 PyInstaller設定
```bash
pyinstaller --onefile --noconsole --name SimpleTodo services/main.py
```

**オプション詳細**:
- `--onefile`: 単一EXE生成
- `--noconsole`: コンソールウィンドウ非表示
- `--name SimpleTodo`: 出力ファイル名
- エントリーポイント: services/main.py

### 5.2 配布物
```
SimpleTodo.exe  ← 実行ファイル
todos.json      ← データファイル（初回起動時に自動生成）
```

## 6. テストケース

### 6.1 単体テスト対象
- models.py: データクラスのシリアライズ/デシリアライズ
- data_manager.py: JSON読み書き、初期化、バックアップ
- todo_service.py: 全CRUD操作、バリデーション

### 6.2 統合テスト
- GUI操作（追加、完了切替、削除）
- イベントハンドリング（ボタン、Enter、ダブルクリック）
- エラーケース（不正なID、空タイトル、JSON破損）
