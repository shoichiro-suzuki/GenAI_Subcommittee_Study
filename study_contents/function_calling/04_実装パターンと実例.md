# 4. 実装パターンと実例

## 4.1 データベースサーチの実装

### ユースケース
自然言語クエリをSQLに変換し、データベースから情報を取得

**例**：「2024年1月の売上が100万円以上の商品を教えて」

### ツール定義例

```python
tools = [{
    "type": "function",
    "function": {
        "name": "search_products",
        "description": "商品データベースを検索する。売上、日付、カテゴリなどの条件で検索可能。",
        "parameters": {
            "type": "object",
            "properties": {
                "start_date": {
                    "type": "string",
                    "description": "検索開始日（YYYY-MM-DD形式）"
                },
                "end_date": {
                    "type": "string",
                    "description": "検索終了日（YYYY-MM-DD形式）"
                },
                "min_sales": {
                    "type": "number",
                    "description": "最低売上金額"
                },
                "category": {
                    "type": "string",
                    "description": "商品カテゴリ"
                }
            },
            "required": []
        }
    }
}]
```

### パラメータ設計のポイント
- **柔軟な検索条件**：required を空にして、任意の条件で検索可能に
- **明確な形式指定**：日付フォーマットを description で明示
- **具体的な説明**：「売上、日付、カテゴリなどの条件で検索可能」と用途を明記

### 実装例

```python
import openai
import sqlite3

def search_products(start_date=None, end_date=None, min_sales=None, category=None):
    """商品データベースを検索"""
    conn = sqlite3.connect('products.db')
    cursor = conn.cursor()

    # 動的にSQLを構築
    query = "SELECT * FROM products WHERE 1=1"
    params = []

    if start_date:
        query += " AND sale_date >= ?"
        params.append(start_date)
    if end_date:
        query += " AND sale_date <= ?"
        params.append(end_date)
    if min_sales:
        query += " AND sales_amount >= ?"
        params.append(min_sales)
    if category:
        query += " AND category = ?"
        params.append(category)

    cursor.execute(query, params)
    results = cursor.fetchall()
    conn.close()

    return results

# OpenAI API呼び出し
response = openai.ChatCompletion.create(
    model="gpt-4o",
    messages=[
        {"role": "user", "content": "2024年1月の売上が100万円以上の商品を教えて"}
    ],
    tools=tools
)

# 関数呼び出しの処理
if response.choices[0].finish_reason == "tool_calls":
    tool_call = response.choices[0].message.tool_calls[0]
    function_name = tool_call.function.name
    arguments = json.loads(tool_call.function.arguments)

    # 関数実行
    if function_name == "search_products":
        result = search_products(**arguments)

        # 結果をフィードバック
        messages.append(response.choices[0].message)
        messages.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "name": function_name,
            "content": json.dumps(result, ensure_ascii=False)
        })

        # 最終レスポンス取得
        final_response = openai.ChatCompletion.create(
            model="gpt-4o",
            messages=messages
        )
```

### エラーハンドリング

```python
def search_products_safe(**kwargs):
    """エラーハンドリング付き検索"""
    try:
        # パラメータ検証
        if 'start_date' in kwargs:
            datetime.strptime(kwargs['start_date'], '%Y-%m-%d')
        if 'end_date' in kwargs:
            datetime.strptime(kwargs['end_date'], '%Y-%m-%d')

        # 検索実行
        return search_products(**kwargs)

    except ValueError as e:
        return {"error": f"日付形式が不正です: {str(e)}"}
    except sqlite3.Error as e:
        return {"error": f"データベースエラー: {str(e)}"}
    except Exception as e:
        return {"error": f"予期しないエラー: {str(e)}"}
```

## 4.2 機械的な処理の実装

### ユースケース
データ変換・計算処理の自動実行

**例**：「この請求書から必要な情報を抽出して」

### ツール定義例：構造化データ抽出

```python
tools = [{
    "type": "function",
    "function": {
        "name": "extract_invoice_data",
        "description": "請求書テキストから構造化データを抽出する",
        "parameters": {
            "type": "object",
            "properties": {
                "invoice_number": {
                    "type": "string",
                    "description": "請求書番号"
                },
                "issue_date": {
                    "type": "string",
                    "description": "発行日（YYYY-MM-DD形式）"
                },
                "amount": {
                    "type": "number",
                    "description": "請求金額"
                },
                "company_name": {
                    "type": "string",
                    "description": "会社名"
                },
                "items": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "quantity": {"type": "number"},
                            "unit_price": {"type": "number"}
                        }
                    },
                    "description": "請求項目リスト"
                }
            },
            "required": ["invoice_number", "amount"]
        }
    }
}]
```

### ツール定義例：データ変換

```python
tools = [{
    "type": "function",
    "function": {
        "name": "convert_data_format",
        "description": "データを指定された形式に変換する（CSV、JSON、XML等）",
        "parameters": {
            "type": "object",
            "properties": {
                "input_format": {
                    "type": "string",
                    "enum": ["csv", "json", "xml", "excel"],
                    "description": "入力データの形式"
                },
                "output_format": {
                    "type": "string",
                    "enum": ["csv", "json", "xml", "excel"],
                    "description": "出力データの形式"
                },
                "data": {
                    "type": "string",
                    "description": "変換対象のデータ（文字列形式）"
                }
            },
            "required": ["input_format", "output_format", "data"]
        }
    }
}]
```

### 実装例：enum活用による安定出力

```python
tools = [{
    "type": "function",
    "function": {
        "name": "classify_category",
        "description": "テキストを指定されたカテゴリに分類する",
        "parameters": {
            "type": "object",
            "properties": {
                "text": {
                    "type": "string",
                    "description": "分類対象のテキスト"
                },
                "category": {
                    "type": "string",
                    "enum": ["技術", "ビジネス", "エンターテイメント", "スポーツ", "その他"],
                    "description": "分類カテゴリ"
                }
            },
            "required": ["text", "category"]
        }
    }
}]
```

**enumのメリット**：
- LLMが定義されたカテゴリのみを返す
- 想定外の値を防ぐ
- 後続処理が安定する

### 実行フロー

```python
def extract_invoice_data(**kwargs):
    """請求書データ抽出（実際はLLMが構造化した結果を受け取るだけ）"""
    # Function Callingでは、LLMが既に構造化済み
    # この関数は検証・保存のみ行う

    # バリデーション
    if kwargs.get('amount', 0) < 0:
        return {"error": "金額は0以上である必要があります"}

    # データベース保存
    save_to_database(kwargs)

    return {"status": "success", "data": kwargs}

# 使用例
response = openai.ChatCompletion.create(
    model="gpt-4o",
    messages=[{
        "role": "user",
        "content": """
        以下の請求書から情報を抽出してください：

        請求書番号: INV-2024-001
        発行日: 2024年1月15日
        株式会社サンプル 御中

        品目: ノートPC x 2台 @150,000円
        品目: モニター x 3台 @30,000円

        合計: 390,000円
        """
    }],
    tools=tools,
    tool_choice={"type": "function", "function": {"name": "extract_invoice_data"}}
)
```

### 結果の構造化出力

LLMは以下のようなJSON引数を生成：

```json
{
  "invoice_number": "INV-2024-001",
  "issue_date": "2024-01-15",
  "amount": 390000,
  "company_name": "株式会社サンプル",
  "items": [
    {"name": "ノートPC", "quantity": 2, "unit_price": 150000},
    {"name": "モニター", "quantity": 3, "unit_price": 30000}
  ]
}
```

**重要**：
- LLMが自動的にテキストを構造化
- 関数側は検証・保存のみ実施
- tool_choice で確実に関数を呼び出し

---

## 参考情報

### データベース検索
- [ChatGPT Function Callingとベクトル検索の組み合わせ - Qiita](https://qiita.com/kuromiya123/items/35f7dc522ecd988015b6)
  - ベクトルDB + Function Callingの実例

- [ChatGPTのFunction callingで複数機能を実装](https://sinyblog.com/python/chatgpt-function-calling/)
  - SQLiteDBを使った実装例

### 構造化データ抽出
- [ChatGPT APIのFunction callingを使って、請求書の構造化データを抽出する - gihyo.jp](https://gihyo.jp/article/2023/07/programming-with-chatgpt-04)
  - 請求書からのデータ抽出実例

- [ChatGPT API + Function Callingで学習データ不要のカテゴリ推定 - Qiita](https://qiita.com/muraokaz/items/602fc300699e6aed4965)
  - enumを活用した分類処理

### 実装パターン
- [ChatGPT APIのFunction callingを使って頑張らずにチャットをアクションに繋げる - Qiita](https://qiita.com/ysv/items/cbdbb994dac790e26489)
  - アクション連携の実装パターン

- [ChatGPT最新機能 Function CallingでQiitaへの理解が深いLINE Botを作る - Qiita](https://qiita.com/watanabe-tsubasa/items/d3cc36ebf41ae81da530)
  - 外部API連携の実例
