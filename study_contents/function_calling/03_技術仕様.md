# 3. 技術仕様

## 3.1 基本的なワークフロー

### フロー図

```
┌──────────────────────────────────────┐
│ 1. ツール定義                         │
│   (名前、説明、入力スキーマ)           │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│ 2. OpenAI APIへのリクエスト            │
│   - messages: ユーザーのプロンプト     │
│   - tools: 関数定義の配列             │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│ 3. LLMによるツール選択・引数生成       │
│   - finish_reason: "tool_calls"      │
│   - tool_calls: [{function, args}]   │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│ 4. クライアント側でツール実行          │
│   ※ OpenAIは実行しない               │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│ 5. 実行結果をAPIへフィードバック       │
│   - role: "tool"                     │
│   - tool_call_id: 呼び出しID         │
│   - content: 実行結果                │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│ 6. 最終レスポンス生成                 │
│   - finish_reason: "stop"            │
│   - content: ユーザーへの回答         │
└──────────────────────────────────────┘
```

### 重要ポイント
- **ステップ4がクライアント側の責任**：OpenAIは関数を実行しない
- **ステップ5で結果をフィードバック**：会話履歴に追加してAPI再呼び出し

## 3.2 ツール定義（JSON Schema）

### 基本構造

```json
{
  "type": "function",
  "function": {
    "name": "関数名",
    "description": "関数の説明",
    "parameters": {
      "type": "object",
      "properties": {
        "パラメータ名": {
          "type": "データ型",
          "description": "パラメータの説明"
        }
      },
      "required": ["必須パラメータ名"]
    }
  }
}
```

### 具体例：天気取得関数

```json
{
  "type": "function",
  "function": {
    "name": "get_current_weather",
    "description": "指定された場所の現在の天気を取得する",
    "parameters": {
      "type": "object",
      "properties": {
        "location": {
          "type": "string",
          "description": "都市名（例：東京、大阪）"
        },
        "unit": {
          "type": "string",
          "enum": ["celsius", "fahrenheit"],
          "description": "温度の単位"
        }
      },
      "required": ["location"]
    }
  }
}
```

### パラメータ設計のポイント
- **description が重要**：LLMがこれを読んで判断する
- **enum で選択肢を制限**：誤った値の生成を防ぐ
- **required で必須項目を指定**：確実に必要な情報を取得

## 3.3 APIリクエスト形式

### messagesパラメータ

通常の会話履歴と同じ形式：

```python
messages = [
    {"role": "system", "content": "あなたは親切なアシスタントです"},
    {"role": "user", "content": "東京の天気を教えて"}
]
```

### toolsパラメータ

利用可能な関数のリスト：

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_weather",
            "description": "天気情報を取得",
            "parameters": {...}
        }
    },
    {
        "type": "function",
        "function": {
            "name": "get_news",
            "description": "ニュースを取得",
            "parameters": {...}
        }
    }
]
```

### tool_choice パラメータ

関数呼び出しの制御：

```python
# 自動判断（デフォルト）
tool_choice = "auto"

# 必ず何かの関数を呼び出す
tool_choice = "required"

# 関数を呼び出さない
tool_choice = "none"

# 特定の関数を強制
tool_choice = {
    "type": "function",
    "function": {"name": "get_weather"}
}
```

## 3.4 レスポンス形式

### 関数呼び出しが必要な場合

```json
{
  "id": "chatcmpl-abc123",
  "choices": [{
    "index": 0,
    "message": {
      "role": "assistant",
      "content": null,
      "tool_calls": [{
        "id": "call_xyz789",
        "type": "function",
        "function": {
          "name": "get_weather",
          "arguments": "{\"location\": \"東京\", \"unit\": \"celsius\"}"
        }
      }]
    },
    "finish_reason": "tool_calls"
  }]
}
```

### 結果のフィードバック形式

関数実行後、結果を会話履歴に追加：

```python
messages.extend([
    # LLMからのツール呼び出し
    {
        "role": "assistant",
        "content": None,
        "tool_calls": [{
            "id": "call_xyz789",
            "type": "function",
            "function": {
                "name": "get_weather",
                "arguments": "{\"location\": \"東京\"}"
            }
        }]
    },
    # 実行結果
    {
        "role": "tool",
        "tool_call_id": "call_xyz789",
        "name": "get_weather",
        "content": "{\"temperature\": 20, \"condition\": \"晴れ\"}"
    }
])
```

### 最終レスポンス

```json
{
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "東京の現在の天気は晴れで、気温は20度です。"
    },
    "finish_reason": "stop"
  }]
}
```

---

## 参考情報

### 技術仕様
- [Function calling - OpenAI API](https://platform.openai.com/docs/guides/function-calling)
  - 公式の技術仕様

- [OpenAI APIのFunction callingを速攻検証 - Qiita](https://qiita.com/yahayuta/items/1ccd261d65273c7c44ff)
  - Python実装での検証例

### JSON Schema
- [Understanding JSON Schema](https://json-schema.org/understanding-json-schema/)
  - JSON Schema公式ガイド

- [ChatGPT APIのFunction callingを使ってみる - Qiita](https://qiita.com/Simossyi/items/046c746f715b6a8b45bc)
  - スキーマ定義の具体例
